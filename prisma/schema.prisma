//////////////////////////////////////////////////////
// DIJITOTRACK ‚Äî PRISMA SCHEMA
// Modules: 0 (System) + 1 (Auth) + 2 (Business)
// Database: PostgreSQL
//////////////////////////////////////////////////////

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// MODULE 0 ‚Äî SYSTEM LEVEL
//////////////////////////////////////////////////////

model SuperAdmin {
  id        String      @id @default(uuid())
  email     String      @unique
  password  String
  role      UserRole
  status    AdminStatus
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model SystemSetting {
  id                   String  @id @default("SYSTEM")
  currency             String
  activePaymentGateway String  @default("SELCOM")
  isBootstrapped       Boolean @default(false)

  // ‚úÖ SECURITY SETTINGS
  maxLoginAttempts Int @default(5)
  lockTimeMinutes  Int @default(15)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////////
// AUTH & USERS
//////////////////////////////////////////////////////
model User {
  id           String     @id @default(uuid())
  email        String
  passwordHash String
  role         UserRole
  status       UserStatus
  businessId   String?
  business     Business?  @relation(fields: [businessId], references: [id])

  passwordResetToken   String?
  passwordResetExpires DateTime?

  lastLoginAt DateTime?

  // ‚úÖ BRUTE FORCE PROTECTION
  failedLoginAttempts Int       @default(0)
  lockUntil           DateTime?

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  emailVerified        Boolean               @default(false)
  emailVerifyToken     String?
  emailVerifyExpires   DateTime?
  refreshTokens        RefreshToken[]
  notifications        Notification[]
  notificationSettings NotificationSetting[]

  @@unique([email, businessId])
}

model Customer {
  id               String         @id @default(uuid())
  businessId       String
  fullName         String
  phone            String
  altPhone         String?
  email            String?
  gender           String?
  dateOfBirth      DateTime?
  addressLine      String?
  ward             String?
  district         String?
  region           String?
  nationalId       String?
  idType           String?
  idVerified       Boolean        @default(false)
  occupation       String?
  employerName     String?
  monthlyIncome    Int?
  guarantorName    String?
  guarantorPhone   String?
  relationship     String?
  status           CustomerStatus
  totalContracts   Int            @default(0)
  activeContracts  Int            @default(0)
  totalPaid        Int            @default(0)
  totalOutstanding Int            @default(0)
  lastPaymentAt    DateTime?
  riskScore        Int?
  isBlacklisted    Boolean        @default(false)
  notes            String?
  pinHash          String?
  otpHash          String?
  otpExpiresAt     DateTime?
  lastLoginAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  business         Business       @relation(fields: [businessId], references: [id])
  contracts        Contract[]
  notifications    Notification[]

  @@unique([phone, businessId])
}

model CustomerImportLog {
  id         String   @id @default(uuid())
  businessId String
  fileName   String
  totalRows  Int
  imported   Int
  skipped    Int
  createdAt  DateTime @default(now())

  @@index([businessId])
}

model RefreshToken {
  id              String    @id @default(uuid())
  token           String    @unique
  userId          String?
  user            User?     @relation(fields: [userId], references: [id])
  customerId      String? // ‚Üê ADD
  expiresAt       DateTime
  createdAt       DateTime  @default(now())
  revokedAt       DateTime?
  replacedByToken String?
}

//////////////////////////////////////////////////////
// BUSINESS (TENANT)
//////////////////////////////////////////////////////
model Business {
  id                          String                       @id @default(uuid())
  name                        String
  email                       String?
  phone                       String?
  businessCode                String                       @unique
  status                      BusinessStatus               @default(PENDING)
  setupCompleted              Boolean                      @default(false)
  users                       User[]
  invites                     BusinessInvite[]
  settings                    BusinessSettings?
  subscriptions               Subscription[]
  subscriptionPayments        SubscriptionPayment[]
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt
  customers                   Customer[]
  notifications               Notification[]
  notificationSettings        NotificationSetting[]
  notificationTemplates       NotificationTemplate[]
  notificationEscalationRules NotificationEscalationRule[]
  bulkNotificationLimits      BulkNotificationLimit[]
  subscriptionUsages          SubscriptionUsage[]
}

model BusinessSettings {
  id         String   @id @default(uuid())
  businessId String   @unique
  currency   String   @default("TZS")
  timezone   String   @default("Africa/Dar_es_Salaam")
  business   Business @relation(fields: [businessId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model BusinessInvite {
  id         String   @id @default(uuid())
  email      String
  role       UserRole
  tokenHash  String
  expiresAt  DateTime
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  createdAt  DateTime @default(now())

  @@index([email])
}

//////////////////////////////////////////////////////
// MODULE: SUBSCRIPTION CORE
//////////////////////////////////////////////////////
model SubscriptionPackage {
  id          String  @id @default(uuid())
  name        String
  code        String  @unique
  description String?

  priceMonthly Int
  priceYearly  Int?
  setupFee     Int  @default(0)
  trialDays    Int  @default(0)

  features Json
  limits   Json?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]
}

model Subscription {
  id String @id @default(uuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  packageId String
  package   SubscriptionPackage @relation(fields: [packageId], references: [id])

  billingCycle BillingCycle

  setupFeeSnapshot     Int
  priceMonthlySnapshot Int
  priceYearlySnapshot  Int

  // üî• NEW ‚Äî Snapshot isolation
  featuresSnapshot Json?
  limitsSnapshot   Json?

  status     SubscriptionStatus
  startDate  DateTime
  endDate    DateTime?
  graceUntil DateTime?

  setupFeePaid Boolean @default(false)

  version       Int @default(1)
  creditBalance Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptionPayments SubscriptionPayment[]

  @@index([businessId])
  @@index([status])
  @@index([businessId, status])
  @@index([businessId, createdAt])
}

model SubscriptionUsage {
  id String @id @default(uuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  metric String
  period String
  value  Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([businessId, metric, period])
  @@index([businessId])
  @@index([metric])
}

model SubscriptionPayment {
  id String @id @default(uuid())

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  amount    Int
  method    SubscriptionPaymentMethod
  reference String?
  status    SubscriptionPaymentStatus

  externalTransactionId String? @unique
  gatewayPayloadHash    String?

  paidAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([businessId])
  @@index([subscriptionId])
  // üîí Enterprise performance indexes
  @@index([status])
  @@index([createdAt])
  @@index([subscriptionId, status])
}

////////////////////////////////////////
//          CONTRACT
////////////////////////////////////
model Contract {
  id         String @id @default(uuid())
  businessId String
  customerId String

  contractNumber String @unique

  customerName  String
  customerPhone String

  title       String
  description String?

  totalValue        Int
  downPayment       Int
  balance           Int
  installmentAmount Int
  totalInstallments Int

  paidAmount        Int @default(0)
  outstandingAmount Int

  frequency  InstallmentFrequency
  customDays Int?

  startDate DateTime
  endDate   DateTime?

  status ContractStatus @default(DRAFT)

  activatedAt  DateTime?
  completedAt  DateTime?
  terminatedAt DateTime?

  terminationReason String?
  terminatedBy      String?

  requiresApproval Boolean   @default(false)
  approvedBy       String?
  approvedAt       DateTime?

  createdBy String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  customer      Customer              @relation(fields: [customerId], references: [id])
  assets        ContractAsset[]
  schedules     InstallmentSchedule[]
  notifications Notification[]

  @@index([businessId])
  @@index([customerId])
}

model InstallmentSchedule {
  id         String @id @default(uuid())
  contractId String

  dueDate DateTime
  amount  Int

  status ScheduleStatus @default(DUE)

  paidAt DateTime?

  createdAt DateTime @default(now())

  contract Contract @relation(fields: [contractId], references: [id])

  @@index([contractId])
}

model ContractAsset {
  id         String @id @default(uuid())
  contractId String

  name      String
  quantity  Int
  unitPrice Int

  createdAt DateTime @default(now())

  contract Contract @relation(fields: [contractId], references: [id])

  @@index([contractId])
}

////////////////////////////////////////
//          PAYMENT
////////////////////////////////////
model Payment {
  id         String @id @default(uuid())
  businessId String
  contractId String
  customerId String

  amount         Int
  channel        String // CASH | MOBILE | BANK
  source         String // POS | WEB | IMPORT | API
  reference      String?
  idempotencyKey String?

  receivedAt DateTime

  balanceBefore Int
  balanceAfter  Int

  status PaymentStatus @default(POSTED)

  attachments Json?

  recordedBy String

  createdAt DateTime @default(now())

  reversals PaymentReversal[]

  @@unique([businessId, idempotencyKey])
  @@index([businessId])
}

model PaymentReversal {
  id        String @id @default(uuid())
  paymentId String
  reason    String

  requestedBy String
  approvedBy  String?

  status ReversalStatus @default(PENDING)

  createdAt  DateTime  @default(now())
  approvedAt DateTime?

  Payment Payment @relation(fields: [paymentId], references: [id])
}

model ApprovalRequest {
  id String @id @default(uuid())

  businessId String

  type       String?
  entityType String
  entityId   String

  requestedBy String
  approvedBy  String?

  status ApprovalStatus @default(PENDING)

  reason       String?
  decisionNote String?

  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  @@index([businessId])
  @@index([entityType])
  @@index([entityId])
  @@index([status])
}

model CustomerCredit {
  id         String   @id @default(uuid())
  businessId String
  customerId String
  balance    Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@unique([businessId, customerId])
}

////////////////////////////////////////
//          DASHBOARDS
////////////////////////////////////
model DashboardSnapshot {
  id           String   @id @default(uuid())
  businessId   String
  snapshotDate DateTime

  portfolio   Int
  collected   Int
  outstanding Int
  overdue     Int

  // Cashflow projections
  cashflow30 Int
  cashflow60 Int
  cashflow90 Int

  createdAt DateTime @default(now())

  @@unique([businessId, snapshotDate])
  @@index([businessId])
}

model DashboardInsight {
  id         String @id @default(uuid())
  businessId String

  type       String
  messageKey String
  payload    Json?

  createdAt DateTime @default(now())

  @@index([businessId])
}

model DashboardStaffMetric {
  id         String @id @default(uuid())
  businessId String
  staffId    String

  collected  Int
  overdue    Int
  efficiency Float

  snapshotDate DateTime
  createdAt    DateTime @default(now())

  @@index([businessId])
  @@index([staffId])
}

model DashboardAssetMetric {
  id         String @id @default(uuid())
  businessId String
  assetId    String

  soldCount  Int
  totalValue Int
  overdue    Int

  snapshotDate DateTime
  createdAt    DateTime @default(now())

  @@index([businessId])
  @@index([assetId])
}

model DashboardHealth {
  id         String @id @default(uuid())
  businessId String

  collectionRate Float
  overdueRatio   Float
  churnRate      Float
  healthScore    Float

  snapshotDate DateTime
  createdAt    DateTime @default(now())

  @@unique([businessId, snapshotDate])
}

///////////////////////////////////
// NOTIFICATIONS
///////////////////////////////////
model Notification {
  id String @id @default(uuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  contractId String?
  contract   Contract? @relation(fields: [contractId], references: [id])

  type    String // UPCOMING | DUE | OVERDUE | ESCALATION | BULK
  channel String // IN_APP | PUSH | SMS | WHATSAPP | EMAIL

  title   String
  message String

  status String // QUEUED | SENT | DELIVERED | READ | FAILED

  retryCount       Int   @default(0)
  providerResponse Json?

  createdAt DateTime  @default(now())
  sentAt    DateTime?
  readAt    DateTime?

  @@index([businessId])
  @@index([customerId])
  @@index([userId])
}

model NotificationSetting {
  id String @id @default(uuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  enableInApp    Boolean @default(true)
  enablePush     Boolean @default(true)
  enableSMS      Boolean @default(true)
  enableWhatsApp Boolean @default(true)
  enableEmail    Boolean @default(true)

  daysBeforeDue Int @default(3)

  muteOverdue   Boolean @default(false)
  muteReminders Boolean @default(false)

  quietHoursStart String?
  quietHoursEnd   String?

  createdAt DateTime @default(now())

  @@unique([businessId, userId])
}

model NotificationTemplate {
  id String @id @default(uuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  type   String
  locale String

  title String @db.VarChar(120)
  body  String @db.VarChar(500)

  createdAt DateTime @default(now())

  @@unique([businessId, type, locale])
}

model NotificationEscalationRule {
  id String @id @default(uuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  daysOverdue  Int
  roleToNotify String // MANAGER | BUSINESS_OWNER

  createdAt DateTime @default(now())

  @@unique([businessId, daysOverdue])
}

model BulkNotificationLimit {
  id String @id @default(uuid())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  weekStart DateTime
  count     Int      @default(0)

  createdAt DateTime @default(now())

  @@unique([businessId, weekStart])
}

model DeviceToken {
  id         String   @id @default(uuid())
  token      String   @unique
  platform   String
  userId     String?
  customerId String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([customerId])
}

////////////////////////////////////////
//          AUDIT LOG
////////////////////////////////////

model AuditLog {
  id String @id @default(uuid())

  businessId String?
  userId     String?
  customerId String?

  entityType String?
  entityId   String?

  action   String
  metadata Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([businessId])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
}

///////////////////////////////////
// SYSTEM ERRORS
///////////////////////////////////
model SystemJobLog {
  id           String    @id @default(uuid())
  jobName      String
  status       String // success | failed
  startedAt    DateTime
  finishedAt   DateTime?
  durationMs   Int?
  errorMessage String?
  retryCount   Int       @default(0)
  createdAt    DateTime  @default(now())

  @@index([jobName])
  @@index([status])
  @@index([createdAt])
}

model SystemErrorGroup {
  id          String   @id @default(uuid())
  signature   String   @unique
  message     String
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @updatedAt
  occurrence  Int      @default(1)

  errors SystemError[]
}

model SystemError {
  id          String   @id @default(uuid())
  groupId     String
  stack       String?
  environment String
  createdAt   DateTime @default(now())

  group SystemErrorGroup @relation(fields: [groupId], references: [id])

  @@index([groupId])
  @@index([createdAt])
}

model SystemHealthSnapshot {
  id              String    @id @default(uuid())
  dbStatus        String
  lastJobRunAt    DateTime?
  failedJobsCount Int       @default(0)
  errorRate       Float     @default(0)
  createdAt       DateTime  @default(now())

  @@index([createdAt])
}

model SupportIncident {
  id          String    @id @default(uuid())
  title       String
  description String
  severity    String // low | medium | high | critical
  status      String    @default("open") // open | investigating | resolved | closed
  assignedTo  String?
  resolvedAt  DateTime?
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([severity])
  @@index([createdAt])
}

model GatewayHealth {
  id        String        @id @default(uuid())
  code      String        @unique
  status    GatewayStatus @default(UNKNOWN)
  lastCheck DateTime?
  updatedAt DateTime      @updatedAt
}

///////////////////////////////////
// ENUMS
///////////////////////////////////
enum GatewayStatus {
  HEALTHY
  DEGRADED
  DOWN
  UNKNOWN
}

enum UserRole {
  SUPER_ADMIN
  BUSINESS_OWNER
  MANAGER
  STAFF
  CUSTOMER
}

enum BusinessStatus {
  PENDING
  ACTIVE
  GRACE
  SUSPENDED
  TERMINATED
}

enum SubscriptionPaymentMethod {
  SELCOM
  MPESA
  AIRTEL
}

enum SubscriptionPaymentStatus {
  PENDING
  CONFIRMED
  FAILED
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  GRACE
  SUSPENDED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
}

enum AdminStatus {
  ACTIVE
  INACTIVE
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  TERMINATED
}

enum InstallmentFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum ScheduleStatus {
  DUE
  PAID
}

enum ContractAction {
  CREATE
  UPDATE
  TERMINATE
  COMPLETE
}

enum PaymentStatus {
  POSTED
  REVERSED
}

enum ReversalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}
