//////////////////////////////////////////////////////
// DIJITOTRACK — PRISMA SCHEMA
// Modules: 0 (System) + 1 (Auth) + 2 (Business)
// Database: PostgreSQL
//////////////////////////////////////////////////////

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// MODULE 0 — SYSTEM LEVEL
//////////////////////////////////////////////////////

model SuperAdmin {
  id        String      @id @default(uuid())
  email     String      @unique
  password  String
  role      UserRole
  status    AdminStatus
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model SystemSetting {
  id             String   @id @default(uuid())
  currency       String
  trialDays      Int
  isBootstrapped Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

//////////////////////////////////////////////////////
// AUTH & USERS
//////////////////////////////////////////////////////

model User {
  id                   String         @id @default(uuid())
  email                String
  passwordHash         String
  role                 UserRole
  status               UserStatus
  businessId           String?
  business             Business?      @relation(fields: [businessId], references: [id])
  passwordResetToken   String?
  passwordResetExpires DateTime?
  lastLoginAt          DateTime?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  emailVerified        Boolean        @default(false)
  emailVerifyToken     String?
  emailVerifyExpires   DateTime?
  refreshTokens        RefreshToken[]

  @@unique([email, businessId])
}

model Customer {
  id               String         @id @default(uuid())
  businessId       String
  fullName         String
  phone            String
  altPhone         String?
  email            String?
  gender           String?
  dateOfBirth      DateTime?
  addressLine      String?
  ward             String?
  district         String?
  region           String?
  nationalId       String?
  idType           String?
  idVerified       Boolean        @default(false)
  occupation       String?
  employerName     String?
  monthlyIncome    Int?
  guarantorName    String?
  guarantorPhone   String?
  relationship     String?
  status           CustomerStatus
  totalContracts   Int            @default(0)
  activeContracts  Int            @default(0)
  totalPaid        Int            @default(0)
  totalOutstanding Int            @default(0)
  lastPaymentAt    DateTime?
  riskScore        Int?
  isBlacklisted    Boolean        @default(false)
  notes            String?
  pinHash          String?
  otpHash          String?
  otpExpiresAt     DateTime?
  lastLoginAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  business         Business       @relation(fields: [businessId], references: [id])
  contracts        Contract[]

  @@unique([phone, businessId])
}

model RefreshToken {
  id         String   @id @default(uuid())
  token      String   @unique
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  customerId String? // ← ADD
  expiresAt  DateTime
  createdAt  DateTime @default(now())
}

//////////////////////////////////////////////////////
// BUSINESS (TENANT)
//////////////////////////////////////////////////////
model Business {
  id             String            @id @default(uuid())
  name           String
  email          String?
  phone          String?
  businessCode   String            @unique
  status         BusinessStatus    @default(PENDING)
  setupCompleted Boolean           @default(false)
  users          User[]
  invites        BusinessInvite[]
  settings       BusinessSettings?
  subscriptions  Subscription[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  customers      Customer[]
}

model BusinessSettings {
  id         String   @id @default(uuid())
  businessId String   @unique
  currency   String   @default("TZS")
  timezone   String   @default("Africa/Dar_es_Salaam")
  business   Business @relation(fields: [businessId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model BusinessInvite {
  id         String   @id @default(uuid())
  email      String
  role       UserRole
  tokenHash  String
  expiresAt  DateTime
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  createdAt  DateTime @default(now())

  @@index([email])
}

//////////////////////////////////////////////////////
// MODULE: SUBSCRIPTION CORE
//////////////////////////////////////////////////////

model Subscription {
  id           String             @id @default(uuid())
  businessId   String             @unique
  business     Business           @relation(fields: [businessId], references: [id])
  plan         SubscriptionPlan
  status       SubscriptionStatus
  startDate    DateTime
  endDate      DateTime?
  setupFeePaid Boolean            @default(false)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
}

////////////////////////////////////////
//          CONTRACT
////////////////////////////////////
model Contract {
  id         String @id @default(uuid())
  businessId String
  customerId String

  contractNumber String @unique

  customerName  String
  customerPhone String

  title       String
  description String?

  totalValue        Int
  downPayment       Int
  balance           Int
  installmentAmount Int
  totalInstallments Int

  paidAmount        Int @default(0)
  outstandingAmount Int

  frequency  InstallmentFrequency
  customDays Int?

  startDate DateTime
  endDate   DateTime?

  status ContractStatus @default(DRAFT)

  activatedAt  DateTime?
  completedAt  DateTime?
  terminatedAt DateTime?

  terminationReason String?
  terminatedBy      String?

  requiresApproval Boolean   @default(false)
  approvedBy       String?
  approvedAt       DateTime?

  createdBy String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  customer  Customer              @relation(fields: [customerId], references: [id])
  assets    ContractAsset[]
  schedules InstallmentSchedule[]

  @@index([businessId])
  @@index([customerId])
}

model InstallmentSchedule {
  id         String @id @default(uuid())
  contractId String

  dueDate DateTime
  amount  Int

  status ScheduleStatus @default(DUE)

  paidAt DateTime?

  createdAt DateTime @default(now())

  contract Contract @relation(fields: [contractId], references: [id])

  @@index([contractId])
}

model ContractAsset {
  id         String @id @default(uuid())
  contractId String

  name      String
  quantity  Int
  unitPrice Int

  createdAt DateTime @default(now())

  contract Contract @relation(fields: [contractId], references: [id])

  @@index([contractId])
}

////////////////////////////////////////
//          PAYMENT
////////////////////////////////////
model Payment {
  id         String @id @default(uuid())
  businessId String
  contractId String
  customerId String

  amount         Int
  channel        String // CASH | MOBILE | BANK
  source         String // POS | WEB | IMPORT | API
  reference      String?
  idempotencyKey String?

  receivedAt DateTime

  balanceBefore Int
  balanceAfter  Int

  status PaymentStatus @default(POSTED)

  attachments Json?

  recordedBy String

  createdAt DateTime @default(now())

  reversals PaymentReversal[]

  @@unique([businessId, idempotencyKey])
  @@index([businessId])
}

model PaymentReversal {
  id        String @id @default(uuid())
  paymentId String
  reason    String

  requestedBy String
  approvedBy  String?

  status ReversalStatus @default(PENDING)

  createdAt  DateTime  @default(now())
  approvedAt DateTime?

  Payment Payment @relation(fields: [paymentId], references: [id])
}

model ApprovalRequest {
  id String @id @default(uuid())

  businessId String
  entityType String
  entityId   String

  requestedBy String
  approvedBy  String?

  status ApprovalStatus @default(PENDING)
  reason String?

  createdAt  DateTime  @default(now())
  resolvedAt DateTime?
}

model CustomerCredit {
  id         String   @id @default(uuid())
  businessId String
  customerId String
  balance    Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@unique([businessId, customerId])
}

////////////////////////////////////////
//          DASHBOARDS
////////////////////////////////////
model DashboardSnapshot {
  id           String   @id @default(uuid())
  businessId   String
  snapshotDate DateTime

  portfolio   Int
  collected   Int
  outstanding Int
  overdue     Int

  // Cashflow projections
  cashflow30 Int
  cashflow60 Int
  cashflow90 Int

  createdAt DateTime @default(now())

  @@unique([businessId, snapshotDate])
  @@index([businessId])
}

model DashboardInsight {
  id         String @id @default(uuid())
  businessId String

  type       String
  messageKey String
  payload    Json?

  createdAt DateTime @default(now())

  @@index([businessId])
}

model DashboardStaffMetric {
  id         String @id @default(uuid())
  businessId String
  staffId    String

  collected  Int
  overdue    Int
  efficiency Float

  snapshotDate DateTime
  createdAt    DateTime @default(now())

  @@index([businessId])
  @@index([staffId])
}

model DashboardAssetMetric {
  id         String @id @default(uuid())
  businessId String
  assetId    String

  soldCount  Int
  totalValue Int
  overdue    Int

  snapshotDate DateTime
  createdAt    DateTime @default(now())

  @@index([businessId])
  @@index([assetId])
}

model DashboardHealth {
  id         String @id @default(uuid())
  businessId String

  collectionRate Float
  overdueRatio   Float
  churnRate      Float
  healthScore    Float

  snapshotDate DateTime
  createdAt    DateTime @default(now())

  @@unique([businessId, snapshotDate])
}

////////////////////////////////////////
//          AUDIT LOG
////////////////////////////////////

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  businessId String?
  userId     String?
  customerId String?
  metadata   Json?
  createdAt  DateTime @default(now())
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum UserRole {
  SUPER_ADMIN
  BUSINESS_OWNER
  MANAGER
  STAFF
  CUSTOMER
}

enum BusinessStatus {
  PENDING
  ACTIVE
  GRACE
  SUSPENDED
  TERMINATED
}

enum SubscriptionPlan {
  STARTER
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  GRACE
  SUSPENDED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
}

enum AdminStatus {
  ACTIVE
  INACTIVE
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  TERMINATED
}

enum InstallmentFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum ScheduleStatus {
  DUE
  PAID
}

enum ContractAction {
  CREATE
  UPDATE
  TERMINATE
  COMPLETE
}

enum PaymentStatus {
  POSTED
  REVERSED
}

enum ReversalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}
